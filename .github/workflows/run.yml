name: test

on:
  # 启用定时任务，每天北京时间凌晨 2 点（UTC 时间前一天 18:00）执行
  schedule:
    - cron: '0 18 * * *'  
  # 手动触发工作流
  workflow_dispatch:  

jobs:
  sign_in:
    # 使用最新的 Ubuntu 环境
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: 【重要】设置系统时区为北京时间 (UTC+8)
        run: sudo timedatectl set-timezone Asia/Shanghai
        continue-on-error: true

      - name: Modify DNS settings
        run: |
          echo "nameserver 8.8.8.8" | sudo tee /etc/resolv.conf > /dev/null
          echo "nameserver 8.8.4.4" | sudo tee -a /etc/resolv.conf > /dev/null
        continue-on-error: false

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
        continue-on-error: false

      - name: Run sign-in script and record log
        run: |
          # 开启错误捕获，记录脚本执行状态（成功/失败）
          set +e
          # 执行签到脚本，同时把脚本所有输出内容保存到临时文件，方便写入日志
          python main.py > script_output.log 2>&1
          # 记录脚本执行的退出码 0=成功 非0=失败
          SCRIPT_EXIT_CODE=$?
          set -e
          
          # ========== 核心：写入日志到 log.md 文件 ==========
          echo -e "---\n## 自动签到执行日志" >> log.md
          echo -e "**执行时间(北京时间)**: $(date +'%Y-%m-%d %H:%M:%S')" >> log.md
          if [ $SCRIPT_EXIT_CODE -eq 0 ]; then
            echo -e "**执行状态**: ✅ 签到成功" >> log.md
          else
            echo -e "**执行状态**: ❌ 签到失败（错误码: $SCRIPT_EXIT_CODE）" >> log.md
          fi
          echo -e "**脚本执行详情**: \n\`\`\`bash\n$(cat script_output.log)\n\`\`\`\n\n" >> log.md
          
          # 删除临时输出文件
          rm -rf script_output.log
        env:
          COOKIES: ${{ secrets.COOKIES }}
          WECHAT_ID: ${{ secrets.WECHAT_ID }}
          WECHAT_SECRET: ${{ secrets.WECHAT_SECRET }}
          WECHAT_APP_ID: ${{ secrets.WECHAT_APP_ID }}
          SERVER_KEY: ${{ secrets.SERVER_KEY }}
        continue-on-error: false

      - name: 自动提交日志文件到仓库
        run: |
          # 配置git提交的用户名和邮箱（固定写法）
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          # 拉取最新代码，避免提交冲突
          git pull origin main --rebase
          # 添加日志文件到暂存区
          git add log.md
          # 提交日志，备注带北京时间
          git commit -m "chore: 自动更新签到日志 $(date +'%Y-%m-%d %H:%M:%S')"
          # 推送提交到仓库（使用github内置token授权，无需手动配置）
          git push origin main
        continue-on-error: true
